# Mise à jour des données

La mise à jour des données n’a pas été automatisée dans sa totalité.

Le script buildDatabase.ts est lançé à chaque déploiement.

Certaines données sont récupérées à ce moment par des API et donc toujours à jour.

Certaines données sont récupérées depuis des fichiers en local dans le repository, qu'il faut récupérer
manuellement et commit dans le repository.

## Données à mettre à jour manuellement

Les sources de données sont dans `apps/web/public/data`.

### Les structures Aidants Connect

Télécharger depuis le metabase le dataset en csv.

https://metabase.aidantsconnect.beta.gouv.fr/question/112-aidants-connect-structure

L’enregistrer dans `apps/web/public/data/aidants-connect_structures.csv`

Pour l'automatisation, il faudrait créer un script qui s'authentifie sur le metabase aidants connect et télécharge le csv.


### IFN - Mednum

Récupérer les fichiers `ifn-city-all-variation.csv` et `ifn-epci-all-variation.csv` par l’équipe IFN de la Mednum.

### Conseiller Numérique - CRA (Compte rendus d’activité)

#### 1. Télécharger les données brutes en local

Exporter les données brutes en csv depuis le metabase conseiller numérique et mettre les fichiers dans `var/`

https://metabase.conseiller-numerique.gouv.fr/question#eyJkYXRhc2V0X3F1ZXJ5Ijp7InR5cGUiOiJxdWVyeSIsInF1ZXJ5Ijp7InNvdXJjZS10YWJsZSI6MTUyLCJmaWVsZHMiOltbImZpZWxkIiwzMTI4LG51bGxdLFsiZmllbGQiLDMxMjYsbnVsbF0sWyJmaWVsZCIsMzEzMyxudWxsXSxbImZpZWxkIiwzMTM3LG51bGxdLFsiZmllbGQiLDMxMzIsbnVsbF0sWyJmaWVsZCIsMzEzNSxudWxsXSxbImZpZWxkIiwzMTMwLG51bGxdLFsiZmllbGQiLDMxMzYsbnVsbF0sWyJmaWVsZCIsMzQ4MCxudWxsXSxbImZpZWxkIiwzNDc4LG51bGxdLFsiZmllbGQiLDM0NzksbnVsbF0sWyJmaWVsZCIsMzQ3NixudWxsXSxbImZpZWxkIiwzNDc3LG51bGxdLFsiZmllbGQiLDMxMjksbnVsbF0sWyJmaWVsZCIsNDQ0NSxudWxsXSxbImZpZWxkIiwzMTM4LG51bGxdLFsiZmllbGQiLDMxMzQsbnVsbF0sWyJmaWVsZCIsNDQ0MyxudWxsXSxbImZpZWxkIiw0NDQyLG51bGxdXSwiZmlsdGVyIjpbImFuZCIsWyJiZXR3ZWVuIixbImZpZWxkIiwzMTI3LG51bGxdLCIyMDIzLTA3LTAxIiwiMjAyMy0xMi0zMSJdXX0sImRhdGFiYXNlIjo5fSwiZGlzcGxheSI6InRhYmxlIiwiZGlzcGxheUlzTG9ja2VkIjp0cnVlLCJwYXJhbWV0ZXJzIjpudWxsLCJ2aXN1YWxpemF0aW9uX3NldHRpbmdzIjp7InRhYmxlLmNvbHVtbnMiOlt7Im5hbWUiOiJfaWQiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEyOCxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY29uc2VpbGxlcklkIiwiZmllbGRSZWYiOlsiZmllbGQiLDMxMjYsbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6ImNyYS5ub21Db21tdW5lIiwiZmllbGRSZWYiOlsiZmllbGQiLDMxMzMsbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6ImNyYS5zdGF0dXQiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEzNyxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLmNvZGVQb3N0YWwiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEzMixudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLmFjY29tcGFnbmVtZW50IiwiZmllbGRSZWYiOlsiZmllbGQiLDMxMzUsbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6ImNyYS50aGVtZXMiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEzMCxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLmFjdGl2aXRlIiwiZmllbGRSZWYiOlsiZmllbGQiLDMxMzYsbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6ImNyYS5hZ2UubW9pbnMxMmFucyIsImZpZWxkUmVmIjpbImZpZWxkIiwzNDgwLG51bGxdLCJlbmFibGVkIjp0cnVlfSx7Im5hbWUiOiJjcmEuYWdlLmRlMTJhMThhbnMiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzQ3OCxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLmFnZS5kZTE4YTM1YW5zIiwiZmllbGRSZWYiOlsiZmllbGQiLDM0NzksbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6ImNyYS5hZ2UuZGUzNWE2MGFucyIsImZpZWxkUmVmIjpbImZpZWxkIiwzNDc2LG51bGxdLCJlbmFibGVkIjp0cnVlfSx7Im5hbWUiOiJjcmEuYWdlLnBsdXM2MGFucyIsImZpZWxkUmVmIjpbImZpZWxkIiwzNDc3LG51bGxdLCJlbmFibGVkIjp0cnVlfSx7Im5hbWUiOiJjcmEubmJQYXJ0aWNpcGFudHMiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEyOSxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLm5iUGFydGljaXBhbnRzUmVjdXJyZW50cyIsImZpZWxkUmVmIjpbImZpZWxkIiw0NDQ1LG51bGxdLCJlbmFibGVkIjp0cnVlfSx7Im5hbWUiOiJjcmEuZHVyZWUiLCJmaWVsZFJlZiI6WyJmaWVsZCIsMzEzOCxudWxsXSwiZW5hYmxlZCI6dHJ1ZX0seyJuYW1lIjoiY3JhLmNhbmFsIiwiZmllbGRSZWYiOlsiZmllbGQiLDMxMzQsbnVsbF0sImVuYWJsZWQiOnRydWV9LHsibmFtZSI6InBlcm1hbmVuY2VJZCIsImZpZWxkUmVmIjpbImZpZWxkIiw0NDQzLG51bGxdLCJlbmFibGVkIjp0cnVlfSx7Im5hbWUiOiJzdHJ1Y3R1cmVJZCIsImZpZWxkUmVmIjpbImZpZWxkIiw0NDQyLG51bGxdLCJlbmFibGVkIjp0cnVlfV0sInRhYmxlLnBpdm90X2NvbHVtbiI6ImNyYS5hY2NvbXBhZ25lbWVudCIsInRhYmxlLmNlbGxfY29sdW1uIjoiY3JhLmFnZS5tb2luczEyYW5zIn0sIm9yaWdpbmFsX2NhcmRfaWQiOjE2N30=

Il faut les exporter pour 2021, 2022, puis de 6 mois en 6 mois car sinon le dataset est trop gros pour metabase.

Ce process est en théorie automatisable mais prendrait beaucoup de temps, l'export metabase étant très lent.

L'idéal serait d'avoir cet aggrégation disponible du côté Conseiller Numérique, mais de la logique de nettoyage est présente dans notre propre code d'aggregation qu'il est difficile de recréer en requête.


#### 2. Aggréger les données par département en local pour mettre à jour le data file

Mettre à jour les fichiers dans `reduceCras.ts` pour avoir le dataset complet.

Runner la commande cli `pnpm cli data:reduce-cras` pour aggréger les données automatiquement et mettre à jour automatiquement le fichier data `conum_departement-cras.json`

